import numpy as np
from matplotlib import pyplot as plt
import scipy.stats as st
from sklearn import metrics


class DelongTest():
    def __init__(self, preds1, preds2, label, threshold=0.05):
        '''
        preds1:the output of model1
        preds2:the output of model2
        label :the actual label
        '''
        self._preds1 = preds1
        self._preds2 = preds2
        self._label = label
        self.threshold = threshold
        self._show_result()

    def _auc(self, X, Y) -> float:
        return 1 / (len(X) * len(Y)) * sum([self._kernel(x, y) for x in X for y in Y])

    def _kernel(self, X, Y) -> float:
        '''
        Mann-Whitney statistic
        '''
        return .5 if Y == X else int(Y < X)

    def _structural_components(self, X, Y) -> list:
        V10 = [1 / len(Y) * sum([self._kernel(x, y) for y in Y]) for x in X]
        V01 = [1 / len(X) * sum([self._kernel(x, y) for x in X]) for y in Y]
        return V10, V01

    def _get_S_entry(self, V_A, V_B, auc_A, auc_B) -> float:
        return 1 / (len(V_A) - 1) * sum([(a - auc_A) * (b - auc_B) for a, b in zip(V_A, V_B)])

    def _z_score(self, var_A, var_B, covar_AB, auc_A, auc_B):
        return (auc_A - auc_B) / ((var_A + var_B - 2 * covar_AB) ** (.5) + 1e-8)

    def _group_preds_by_label(self, preds, actual) -> list:
        X = [p for (p, a) in zip(preds, actual) if a]
        Y = [p for (p, a) in zip(preds, actual) if not a]
        return X, Y

    def _compute_z_p(self):
        X_A, Y_A = self._group_preds_by_label(self._preds1, self._label)
        X_B, Y_B = self._group_preds_by_label(self._preds2, self._label)

        V_A10, V_A01 = self._structural_components(X_A, Y_A)
        V_B10, V_B01 = self._structural_components(X_B, Y_B)

        auc_A = self._auc(X_A, Y_A)
        auc_B = self._auc(X_B, Y_B)

        # Compute entries of covariance matrix S (covar_AB = covar_BA)
        var_A = (self._get_S_entry(V_A10, V_A10, auc_A, auc_A) * 1 / len(V_A10) + self._get_S_entry(V_A01, V_A01, auc_A,
                                                                                                    auc_A) * 1 / len(
            V_A01))
        var_B = (self._get_S_entry(V_B10, V_B10, auc_B, auc_B) * 1 / len(V_B10) + self._get_S_entry(V_B01, V_B01, auc_B,
                                                                                                    auc_B) * 1 / len(
            V_B01))
        covar_AB = (self._get_S_entry(V_A10, V_B10, auc_A, auc_B) * 1 / len(V_A10) + self._get_S_entry(V_A01, V_B01,
                                                                                                       auc_A,
                                                                                                       auc_B) * 1 / len(
            V_A01))

        # Two tailed test
        z = self._z_score(var_A, var_B, covar_AB, auc_A, auc_B)
        p = st.norm.sf(abs(z)) * 2

        return z, p

    def _show_result(self):
        z, p = self._compute_z_p()
        print(f"z score = {z:.15f};\np value = {p:.15f};")
        if p < self.threshold:
            print("There is a significant difference")
        else:
            print("There is NO significant difference")


# Model A (random) vs. "good" model B
preds_A = np.array([0.84235, 0.15765,
0.24370, 0.75630,
0.33228, 0.66772,
0.42495, 0.57505,
0.61980, 0.38020,
0.37214, 0.62786,
0.18146, 0.81854,
0.67364, 0.32636,
0.28709, 0.71291,
0.93461, 0.06539,
0.86380, 0.13620,
0.13554, 0.86446,
0.30900, 0.69100,
0.42758, 0.57242,
0.74956, 0.25044,
0.99922, 0.00078,
0.57054, 0.42946,
0.80787, 0.19213,
0.36931, 0.63069,
0.53411, 0.46589,
0.26045, 0.73955,
0.86912, 0.13088,
0.37422, 0.62578,
0.22369, 0.77631,
0.44123, 0.55877,
0.27398, 0.72602,
0.31320, 0.68680,
0.77782, 0.22218,
0.30972, 0.69028,
0.90179, 0.09821,
0.80263, 0.19737,
0.56894, 0.43106,
0.41962, 0.58038,
0.37149, 0.62851,
0.52313, 0.47687,
0.21840, 0.78160,
0.41343, 0.58657,
0.91155, 0.08845,
0.99482, 0.00518,
0.34498, 0.65502,
0.74739, 0.25261,
0.31454, 0.68546,
0.65901, 0.34099,
0.63075, 0.36925,
0.44332, 0.55668,
0.30112, 0.69888,
0.37473, 0.62527,
0.14660, 0.85340,
]).reshape(-1, 2)
preds_B = np.array([0.93712, 0.06288,
0.79201, 0.20799,
0.14072, 0.85928,
0.63278, 0.36722,
0.24329, 0.75671,
0.84762, 0.15238,
0.34099, 0.65901,
0.81951, 0.18049,
0.32704, 0.67296,
0.32822, 0.67178,
0.91536, 0.08464,
0.58781, 0.41219,
0.80771, 0.19229,
0.93042, 0.06958,
0.24641, 0.75359,
0.14401, 0.85599,
0.22222, 0.77778,
0.76334, 0.23666,
0.12772, 0.87228,
0.70028, 0.29972,
0.82537, 0.17463,
0.97290, 0.02710,
0.83699, 0.16301,
0.26648, 0.73352,
0.84442, 0.15558,
0.34319, 0.65681,
0.19585, 0.80415,
0.34230, 0.65770,
0.68187, 0.31813,
0.34638, 0.65362,
0.60106, 0.39894,
0.72173, 0.27827,
0.47736, 0.52264,
0.60705, 0.39295,
0.37257, 0.62743,
0.87185, 0.12815,
0.38362, 0.61638,
0.13206, 0.86794,
0.47312, 0.52688,
0.48360, 0.51640,
0.30378, 0.69622,
0.37464, 0.62536,
0.62960, 0.37040,
0.63157, 0.36843,
0.29861, 0.70139,
0.42094, 0.57906,
0.27250, 0.72750,
0.65231, 0.34769,
0.79123, 0.20877,
0.24845, 0.75155,
0.52367, 0.47633,
0.29629, 0.70371,
0.17647, 0.82353,
0.41917, 0.58083,
0.21082, 0.78918,
0.31786, 0.68214,
0.32056, 0.67944,
0.45340, 0.54660,
0.75361, 0.24639,
0.66940, 0.33060,
0.13665, 0.86335,
0.50679, 0.49321,
0.62816, 0.37184,
0.88609, 0.11391,
0.40197, 0.59803,
0.67840, 0.32160,
0.12371, 0.87629,
0.17814, 0.82186,
0.66156, 0.33844,
0.22654, 0.77346,
0.79614, 0.20386,
0.19397, 0.80603,
0.15092, 0.84908,
0.94920, 0.05080,
0.26304, 0.73696,
0.27007, 0.72993,
0.09317, 0.90683,
0.61593, 0.38407,
0.87880, 0.12120,
0.42955, 0.57045,
0.58234, 0.41766,
0.90441, 0.09559,
0.96379, 0.03621,
0.29729, 0.70271,
0.23245, 0.76755,
0.50843, 0.49157,
0.07967, 0.92033,
0.94193, 0.05807,
0.23986, 0.76014,
0.22587, 0.77413,
0.18379, 0.81621,
0.23100, 0.76900,
0.17193, 0.82807,
0.34202, 0.65798,
0.48022, 0.51978,
0.88442, 0.11558,
0.34708, 0.65292,
0.27058, 0.72942,
0.18589, 0.81411,
0.39867, 0.60133,
0.31531, 0.68469,
0.32199, 0.67801,
0.17199, 0.82801,
0.50679, 0.49321,
0.11076, 0.88924,
0.81566, 0.18434,
0.83139, 0.16861,
0.94661, 0.05339,
0.51238, 0.48762,
0.16522, 0.83478,
0.17415, 0.82585,
0.61150, 0.38850,
0.90222, 0.09778,
0.97866, 0.02134,
0.81191, 0.18809,
0.60231, 0.39769,
0.74434, 0.25566,
0.83312, 0.16688,
0.63150, 0.36850,
0.78819, 0.21181,
0.29544, 0.70456,
0.44109, 0.55891,
0.20945, 0.79055,
0.84522, 0.15478,
0.47530, 0.52470,
0.55603, 0.44397,
0.58062, 0.41938,
0.39162, 0.60838,
0.12298, 0.87702,
0.47020, 0.52980,
0.35838, 0.64162,
0.10987, 0.89013,
0.64281, 0.35719,
0.69842, 0.30158,
0.28377, 0.71623,
0.28378, 0.71622,
0.45494, 0.54506,
0.24047, 0.75953,
0.22508, 0.77492,
0.52443, 0.47557,
0.89708, 0.10292,
0.11354, 0.88646,
0.83707, 0.16293,
0.19479, 0.80521,
0.23457, 0.76543,
0.73750, 0.26250,
0.38976, 0.61024,
0.47470, 0.52530,
0.89860, 0.10140,
0.56608, 0.43392,
0.44060, 0.55940,
0.63905, 0.36095,
0.32043, 0.67957,
0.15738, 0.84262,
0.18474, 0.81526,
0.94511, 0.05489,
0.88072, 0.11928,
0.20747, 0.79253,
0.80897, 0.19103,
0.30016, 0.69984,
0.08511, 0.91489,
0.50350, 0.49650,
0.45280, 0.54720,
0.44178, 0.55822,
0.73188, 0.26812,
0.33251, 0.66749,
0.15593, 0.84407,
0.19078, 0.80922,
0.14571, 0.85429,
0.20877, 0.79123,
0.84773, 0.15227,
0.14052, 0.85948,
0.20792, 0.79208,
0.18069, 0.81931,
0.84060, 0.15940,
0.89620, 0.10380,
0.18908, 0.81092,
0.21602, 0.78398,
]).reshape(-1, 2)
actual = np.array([0,0,1,0,1,0,0,0,1,1,0,0,0,0,1,1,1,0,1,0,0,0,0,1,0,1,1,0,0,0,1,0,0,1,1,0,1,1,0,0,0,0,0,0,0,1,1,0,0,1,0,0,1,1,1,1,1,1,0,0,1,0,0,1,1,1,1,0,0,1,0,0,1,0,1,1,1,0,0,0,1,1,0,1,0,1,1,1,1,1,1,1,1,1,1,0,0,1,1,1,1,1,1,0,1,0,1,0,0,1,1,1,0,0,0,1,0,0,0,0,1,0,1,1,1,0,1,0,1,1,1,1,0,0,1,1,0,1,1,0,0,1,0,1,1,1,1,1,0,0,0,0,0,0,1,0,0,0,0,1,1,0,0,1,0,1,1,1,1,1,0,1,1,1,0,0,1,1
])
DelongTest(preds_A[:,1], preds_B[:,1], actual)
